version: 2

models:
  - name: int_onprem_subscriptions
    description: |
      Reconstructed `onprem_subscriptions` table using Stripe events. 
      We are fetching all paid invoices data. Paid invoices in On-Prem have subtotal > 0. Hence the filter amount > 0.
      When the customer pays for an expansion they first get refunded the original purchase amount 
      and get charged for the new amount based on the new number of seats purchased. 
      So in any subscription where an expansion has happened, we will see 3 rows of data in invoice_line_items.
        -  The original purchase amount
        -  The refunded amount which is < 0 (this is not required in SFDC, after I spoke to John)
        -  The new amount charged.

      We are only interested for the amount, from these 3 rows of data, from Invoice Line Items the invoice amounts > 0. 
      Since that is the actual amount paid for the expansion. For seats, they always show the total seats after the expansion.
      we need to subtract the total seats from the previous purchase. You can see the calculation (Lag functions) in the code.
      

    columns:  
      - name: opportunity_type 
      - name: order_type 
      - name: ownerid 
      - name: stagename 
      - name: opportunity_name 
      - name: subscription_id 
      - name: purchase_order_number 
      - name: stripe_customer_id
        tests:
          - not_null
      - name: license_id 
      - name: edition 
      - name: product 
      - name: sku 
      - name: charge 
      - name: subscription 
      - name: invoice_number 
      - name: stripe_invoice_number 
      - name: invoice_id
        tests:
          - not_null
          - unique      
      - name: invoice_created_at 
      - name: email 
      - name: domain 
      - name: customer_name 
      - name: line1 
      - name: line2 
      - name: postal_code 
      - name: city 
      - name: state 
      - name: country 
      - name: customer_full_name 
      - name: total 
      - name: subtotal 
      - name: invoice_row_num 
      - name: invoice_quantity 
      - name: previous_quantity 
      - name: seats_purchased